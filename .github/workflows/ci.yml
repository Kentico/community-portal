name: "CI: Build and Test"

on:
  pull_request:
    branches: [main]
    paths:
      - "**.cs"
      - "**.csproj"
      - "**.props"
      - "**.targets"
      - "**.sln"
      - "**.ps1"
      - "**.config"
      - "**.yml"
      - "**.json"
      - "**.css"
      - "**.scss"
      - "**.ts"
      - "**.tsx"
      - "**.js"
      - "**.razor"

# Cancel in-progress runs when a new commit is pushed
concurrency:
  group:
    ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build_and_test:
    name: Build and Test
    runs-on: ubuntu-latest
    timeout-minutes: 30 # Fail if workflow takes longer than expected
    defaults:
      run:
        shell: pwsh

    env:
      ASPNETCORE_ENVIRONMENT: CI
      DATABASE_BACKUP_FILENAME: ""
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
      DOTNET_NOLOGO: 1
      NO_COLOR: 1
      DOTNET_SYSTEM_CONSOLE_ALLOW_ANSI_COLOR_REDIRECTION: false
      PROJECT_NAME: Kentico.Community.Portal.Web
      ASPNETCORE_URLS: https://localhost:45039;https://localhost:45040
      STATUS_CHECK_URL: https://localhost:45039/status
      SQL_SA_PASSWORD: Pass@12345

    steps:
      # === Environment Setup ===
      - uses: actions/checkout@v6

      - name: Setup Node.js (from package.json)
        uses: actions/setup-node@v6
        with:
          node-version-file: "src/Kentico.Community.Portal.Web/package.json"
          cache: "npm"
          cache-dependency-path: "src/Kentico.Community.Portal.Web/package-lock.json"

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          global-json-file: global.json

      - name: Cache NuGet packages
        uses: actions/cache@v5
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      # === Build ===
      - name: Install dependencies
        run: dotnet restore --locked-mode

      - name: Build Solution
        run: |
          dotnet build `
            -c Release `
            --no-restore

      # === Database Setup ===
      - name: Get Database Backup Name
        run: |
          $latestBackup = Get-ChildItem -Path "./database" -Filter "*.zip" | Select-Object -ExpandProperty BaseName
          "DATABASE_BACKUP_FILENAME=$latestBackup" >> $env:GITHUB_ENV

      - name: Extract Database Backup
        run: |
          Expand-Archive `
            -Path "./database/${{ env.DATABASE_BACKUP_FILENAME }}.zip" `
            -DestinationPath "./database"

      - name: Install SQL Server (2022)
        uses: potatoqualitee/mssqlsuite@v1.12
        with:
          install: sqlpackage, sqlengine, sqlclient
          sa-password: ${{ env.SQL_SA_PASSWORD }}
          version: 2022

      - name: Restore Database from Backup
        run: |
          Write-Output "Copying database backup to SQL container..."
          docker cp "./database/${{ env.DATABASE_BACKUP_FILENAME }}" sql:/var/backups/Kentico.Community.bak
          docker exec -u root sql bash -c "chown mssql:mssql /var/backups/Kentico.Community.bak"
          docker exec -u root sql bash -c "chmod 644 /var/backups/Kentico.Community.bak"

          Write-Output "Verifying backup file contents..."
          $fileList = sqlcmd `
            -S localhost `
            -d master `
            -U "sa" `
            -P "${{ env.SQL_SA_PASSWORD }}" `
            -N o `
            -C `
            -Q "RESTORE FILELISTONLY FROM DISK = '/var/backups/Kentico.Community.bak'"

          Write-Output $fileList

          Write-Output "Restoring database..."
          sqlcmd `
            -S localhost `
            -d master `
            -U "sa" `
            -P "${{ env.SQL_SA_PASSWORD }}" `
            -N o `
            -C `
            -i ./database/backup-restore.sql

          Write-Output "âœ“ Database restored successfully"
          "## âœ“ Database Restored" >> $env:GITHUB_STEP_SUMMARY

      - name: Restore License Key
        working-directory: "./scripts"
        run: |
          ./Restore-LicenseKey.ps1 -LicenseKey ${{ secrets.XPERIENCE_LICENSE_KEY }}

      - name: Restore CI Repository
        working-directory: "./scripts"
        run: |
          ./Restore-CI.ps1
          "## âœ“ CI Repository Restored" >> $env:GITHUB_STEP_SUMMARY

      # === Testing ===
      - name: Run Unit Tests
        working-directory: "./scripts"
        run: |
          Write-Output "## ðŸ§ª Unit Tests" >> $env:GITHUB_STEP_SUMMARY

          $summary = ./Run-Unit-Tests.ps1 -ProjectPath "../test/Kentico.Community.Portal.Web.Tests/Kentico.Community.Portal.Web.Tests.csproj"
          $summary >> $env:GITHUB_STEP_SUMMARY

      - name: Run Integration Tests
        working-directory: "./scripts"
        run: |
          Write-Output "## ðŸ”— Integration Tests" >> $env:GITHUB_STEP_SUMMARY

          $summary = ./Run-Integration-Tests.ps1 -ProjectPath "../test/Kentico.Community.Portal.Web.Integration.Tests/Kentico.Community.Portal.Web.Integration.Tests.csproj"
          $summary >> $env:GITHUB_STEP_SUMMARY

      # === E2E Testing ===
      - name: Publish Application
        run: |
          Write-Output "Publishing application..."
          dotnet publish `
            ./src/${{ env.PROJECT_NAME }} `
            -c Release `
            -o ./publish `
            --no-build `
            --no-restore
          Write-Output "âœ“ Application published to ./publish"

      - name: Cache Playwright browsers
        id: playwright-cache
        uses: actions/cache@v5
        with:
          path: ~/.cache/ms-playwright
          key:
            ${{ runner.os }}-playwright-${{ hashFiles('**/packages.lock.json')
            }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright Dependencies
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: |
          Write-Output "Installing Playwright browsers..."
          # Must be path to the RELEASE build
          ./test/Kentico.Community.Portal.Web.E2E.Tests/bin/Release/net10.0/playwright.ps1 install
          Write-Output "âœ“ Playwright browsers installed"

      - name: Cache Azurite
        id: azurite-cache
        uses: actions/cache@v5
        with:
          path: ~/.npm
          key: ${{ runner.os }}-azurite-3.35.0

      - name: Install Azurite
        if: steps.azurite-cache.outputs.cache-hit != 'true'
        run: npm install -g azurite@3.35.0

      - name: Start Azurite (Background)
        run: |
          azurite -s -l ./.azurite &
          Write-Output "âœ“ Azurite storage emulator started"

      - name: Run E2E Tests (with App)
        working-directory: "./scripts"
        run: |
          Write-Output "## ðŸŽ­ E2E Tests" >> $env:GITHUB_STEP_SUMMARY

          $summary = ./Run-E2E-Tests.ps1 `
            -PublishPath "../publish" `
            -AppDllName "${{ env.PROJECT_NAME }}.dll" `
            -StatusCheckUrl "${{ env.STATUS_CHECK_URL }}" `
            -TestProjectPath "../test/Kentico.Community.Portal.Web.E2E.Tests/Kentico.Community.Portal.Web.E2E.Tests.csproj" `
            -TestSettings "../test/e2e.runsettings" `
            -MaxWaitSeconds 30
          $summary >> $env:GITHUB_STEP_SUMMARY

      # === Artifacts (on failure) ===
      - name: Upload Application Logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: application-logs-${{ github.run_number }}
          path: |
            publish/app-*.log
          retention-days: 7
          if-no-files-found: ignore
