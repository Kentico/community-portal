name: "Deploy to SaaS"

on:
  workflow_dispatch:
    inputs:
      reason:
        description: "The reason for running the workflow"
        required: true
        default: "Manual run"
      environment:
        description: "Target environment for deployment"
        required: false
        default: "qa"
        type: choice
        options:
          - qa
          - uat
          - prod
      archive_package:
        description: "Archive deployment package as artifact"
        required: false
        default: false
        type: boolean

# Prevent concurrent deployments to the same environment
concurrency:
  group: deploy-${{ inputs.environment }}
  cancel-in-progress: false

jobs:
  createDeploymentPackage:
    name: Create SaaS Deployment Package
    runs-on: ubuntu-latest
    timeout-minutes: 30
    defaults:
      run:
        shell: pwsh

    env:
      ASPNETCORE_ENVIRONMENT: CI
      DATABASE_BACKUP_FILENAME: ""
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
      DOTNET_NOLOGO: 1
      PROJECT_NAME: Kentico.Community.Portal.Web
      SQL_SA_PASSWORD: Pass@12345

    steps:
      # === Environment Setup ===
      - uses: actions/checkout@v6

      - name: Setup Node.js (from package.json)
        uses: actions/setup-node@v6
        with:
          node-version-file: "src/Kentico.Community.Portal.Web/package.json"
          cache: "npm"
          cache-dependency-path: "src/Kentico.Community.Portal.Web/package-lock.json"

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          global-json-file: global.json

      - name: Cache NuGet packages
        uses: actions/cache@v5
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      # === Build ===
      - name: Install dependencies
        run: dotnet restore --locked-mode

      - name: Build Solution
        run: |
          dotnet build ./src/${{ env.PROJECT_NAME }}/ `
            -c Release `
            --no-restore

      # === Database Setup ===
      - name: Get Database Backup Name
        run: |
          $latestBackup = Get-ChildItem -Path "./database" -Filter "*.zip" | Select-Object -ExpandProperty BaseName
          "DATABASE_BACKUP_FILENAME=$latestBackup" >> $env:GITHUB_ENV

      - name: Extract Database Backup
        run: |
          Expand-Archive `
            -Path "./database/${{ env.DATABASE_BACKUP_FILENAME }}.zip" `
            -DestinationPath "./database"

      - name: Install SQL Server (2022)
        uses: potatoqualitee/mssqlsuite@v1.12
        with:
          install: sqlpackage, sqlengine, sqlclient
          sa-password: ${{ env.SQL_SA_PASSWORD }}
          version: 2022

      - name: Restore Database from Backup
        run: |
          Write-Output "Copying database backup to SQL container..."
          docker cp "./database/${{ env.DATABASE_BACKUP_FILENAME }}" sql:/var/backups/Kentico.Community.bak
          docker exec -u root sql bash -c "chown mssql:mssql /var/backups/Kentico.Community.bak"
          docker exec -u root sql bash -c "chmod 644 /var/backups/Kentico.Community.bak"

          Write-Output "Restoring database..."
          sqlcmd `
            -S localhost `
            -d master `
            -U "sa" `
            -P "${{ env.SQL_SA_PASSWORD }}" `
            -N o `
            -C `
            -i ./database/backup-restore.sql

          Write-Output "âœ“ Database restored successfully"
          "## âœ“ Database Restored" >> $env:GITHUB_STEP_SUMMARY

      - name: Restore License Key
        working-directory: "./scripts"
        run: |
          ./Restore-LicenseKey.ps1 -LicenseKey ${{ secrets.XPERIENCE_LICENSE_KEY }}

      - name: Restore CI Repository
        working-directory: "./scripts"
        run: |
          ./Restore-CI.ps1
          "## âœ“ CI Repository Restored" >> $env:GITHUB_STEP_SUMMARY

      # === Package Generation ===
      - name: Generate Deployment Package
        working-directory: "./scripts"
        run: |
          Write-Output "Generating deployment package with zero-downtime support..."
          ./Export-DeploymentPackage.ps1 -ZeroDowntimeSupportEnabled -CompressPackage
          Write-Output "âœ“ Deployment package created"
          "## ðŸ“¦ Deployment Package Created" >> $env:GITHUB_STEP_SUMMARY

      # === Deployment ===
      - name: Upload Deployment Package to ${{ inputs.environment }}
        run: |
          Write-Output "Uploading deployment package to ${{ inputs.environment }}..."
          Write-Output "Reason: ${{ inputs.reason }}"

          $headers = @{ Authorization = "Bearer ${{ secrets.XPERIENCE_PORTAL_DEPLOYMENT_PAT }}" }
          $response = Invoke-RestMethod `
            -Uri https://xperience-portal.com/api/deployment/upload/${{ secrets.XPERIENCE_PORTAL_PROJECT_GUID }}/${{ inputs.environment }} `
            -Method Post `
            -InFile './DeploymentPackage.zip' `
            -ContentType "application/zip" `
            -Headers $headers

          Write-Output "âœ“ Package uploaded successfully to ${{ inputs.environment }}"
          "## âœ… Deployed to ${{ inputs.environment }}" >> $env:GITHUB_STEP_SUMMARY
          "**Reason:** ${{ inputs.reason }}" >> $env:GITHUB_STEP_SUMMARY

      - name: Archive Deployment Package
        if: ${{ inputs.archive_package }}
        uses: actions/upload-artifact@v4
        with:
          name:
            deployment-package-${{ inputs.environment }}-${{ github.run_number
            }}
          path: DeploymentPackage.zip
          retention-days: 30
          compression-level: 0 # Already compressed
