@using Kentico.Community.Portal.Web.Features.QAndA

@model QAndAPostAnswerViewModel

@{
    var guid = $"{Model.GUID:N}";
    string wrapperElId = $"answer_{guid}";
    string markAnswerFormElId = $"markAsAnswerForm_{guid}";
}

<div id="@wrapperElId" class="my-3" q-and-a-answer style="--bg-target: var(--bs-purple-100)"
    data-accepted="@JSEncoder.EncodeToJson(Model.IsAcceptedAnswer)" data-created="@Model.DateCreated.Ticks"
    data-reactions="@Model.Reactions.ReactionCount">
    <article class="border rounded-3 p-3 @(Model.IsAcceptedAnswer ? "border-success" : "")">
        <div class="mb-3 d-flex justify-content-between gap-1" data-ktc-search-exclude>
            <vc:author author="Model.Author" />

            <div>
                <div class="d-flex align-items-center">
                    <time xpc-datetime="Model.DateCreated" class="text-nowrap"></time>
                    <a href="#@wrapperElId" class="answer-link ps-1" title="Navigate to this answer"
                        aria-label="Navigate to this answer"></a>
                </div>

                @if (Model.IsAcceptedAnswer)
                {
                    <div class="text-success text-end">
                        <svg class="me-1" width="16" height="16" viewBox="0 0 16 16" aria-hidden="true">
                            <use xlink:href="/img/icons.svg#check" asp-append-version></use>
                        </svg>
                        <span class="fs-6">
                            <strong>Accepted answer</strong>
                        </span>
                    </div>
                }
            </div>

        </div>

        <div class="member-generated-content overflow-auto" hx-disable>
            @Model.HTMLSanitizedContentHTML
        </div>

        <div class="d-flex gap-1 mt-2 justify-content-between">

            <div class="mt-3">
                <partial name="~/Features/QAndA/_QAndAAnswerReaction.cshtml" model="@Model.Reactions" />
            </div>

            <div class="d-flex gap-1 align-self-end">
                @if (Model.Permissions.MarkApprovedAnswer)
                {
                    <form id="@markAnswerFormElId" method="post" hx-post hx-controller="QAndAAnswer"
                        hx-action="MarkApprovedAnswer" hx-route-questionID="@Model.ParentQuestionID"
                        hx-route-answerID="@Model.ID" class="align-self-center">
                        <button type="submit" class="btn btn-outline-primary btn-sm text-wrap"
                            title="This response will be marked as the accepted response. You can only do this once.">
                            Mark as answer
                        </button>
                    </form>
                }

                @if (Model.Permissions.Edit)
                {
                    <button type="button" class="btn btn-sm btn-outline-secondary" hx-get hx-controller="QAndAAnswer"
                        hx-action="DisplayEditAnswerForm" hx-route-questionID="@Model.ParentQuestionID"
                        hx-route-answerID="@Model.ID" hx-swap="outerHTML" hx-target="#@wrapperElId">
                        Edit
                    </button>
                }
                @if (Model.Permissions.Delete)
                {
                    <form method="post" hx-post hx-controller="QAndAAnswer" hx-action="DeleteAnswer"
                        hx-route-questionID="@Model.ParentQuestionID" hx-route-answerID="@Model.ID" hx-swap="delete"
                        hx-confirm="Do you want to delete this answer?" hx-target="#@wrapperElId">
                        <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                    </form>
                }
            </div>
        </div>

    </article>
</div>

@{
    if (Context.Request.IsHtmx())
    {
        <script type="module">
            const el = document.querySelector('#@wrapperElId');
            window.Prism.highlightAllUnder(el);
        </script>
    }
}